## 1. Auth.jsë€?

Auth.jsëŠ” í‘œì¤€ ì›¹ APIë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ëŸ°íƒ€ì„ ë…ë¦½ì ì¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤. ë‹¤ì–‘í•œ ìµœì‹  Javascript í”„ë ˆì„ì›Œí¬ì™€ ê¹Šì´ ìˆê²Œ í†µí•©ë˜ì–´, ê°„ë‹¨í•˜ê²Œ ì‹œì‘í•  ìˆ˜ ìˆê³  í™•ì¥ì´ ìš©ì´í•˜ë©° í•­ìƒ í”„ë¦¬ì´ë²„ì‹œì™€ ë³´ì•ˆì´ ë³´ì¥ë˜ëŠ” ì¸ì¦ ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤!


> **Note:** ì´ ê¸€ì€ `next-auth@5.0.0-beta` ì´ìƒ ë²„ì „ê³¼ `@auth/*` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•„ë˜ì˜ ëª¨ë“  í”„ë ˆì„ì›Œí¬ë¥¼ ë‹¤ë£¨ê³  ìˆìŠµë‹ˆë‹¤.

- Next.js: `14.2.15`
- Auth.js: `5.0.0-beta`

ìœ„ ë²„ì „ìœ¼ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

## 2. ì„¤ì¹˜ ë° í™˜ê²½ì„¤ì •
```npm install next-auth@beta```

```npx auth secret```

í•„ìˆ˜ì ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•˜ëŠ” í™˜ê²½ë³€ìˆ˜ëŠ” `AUTH_SECRET`ë¿ì…ë‹ˆë‹¤. ì´ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í† í°ê³¼ ì´ë©”ì¼ ì¸ì¦ í•´ì‹œë¥¼ ì•”í˜¸í™”í•˜ëŠ”ë° ì‚¬ìš©í•˜ëŠ” ì„ì˜ì˜ ê°’ì…ë‹ˆë‹¤.

`Auth_SECRET`ì€ Auth.js(NextAuth)ì—ì„œ ë§¤ìš° ì¤‘ìš”í•œ ë³´ì•ˆ í‚¤ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
1. ì„¸ì…˜ì•”í˜¸í™”: JWTí† í°ì„ ì•”í˜¸í™”í•˜ê³  ì„œëª…í•˜ëŠ”ë° ì‚¬ìš©
2. ì´ë©”ì¼ ê²€ì¦: ì´ë©”ì¼ í™•ì¸ ë§í¬ì˜ í† í°ì„ ìƒì„± í•  ë•Œ ì‚¬ìš©
3. CSRF ë³´í˜¸: CSRF í† í°ì„ ìƒì„±í•˜ëŠ”ë° ì‚¬ìš©

## 3. Credentials(ìê²© ì¦ëª…)
Auth.jsì—ì„œëŠ” ìì²´ ì¸ì¦ ë°©ì‹ì´ë‚˜ ì™¸ë¶€ ì¸ì¦ì„ ì ìš©í•  ë•Œ Credentials Providerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ì œê³µìëŠ” ì‚¬ìš©ì ì´ë¦„(ì´ë©”ì¼)ê³¼ ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ ìê²© ì •ë³´ë¥¼ ë¡œê·¸ì¸ í¼ìœ¼ë¡œ ì…ë ¥í•˜ê²Œ í•´, ì´ë¥¼ ì„¤ì •ëœ ì¸ì¦ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

Credentials ProvidersëŠ” `authorize` ì½œë°±ì„ í†µí•´ ìê²© ì •ë³´(ì´ë©”ì¼, íŒ¨ìŠ¤ì›Œë“œ)ë¥¼ ì„œë²„ë¡œ ì „ë‹¬í•˜ì—¬ ì¸ì¦ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì´ ì½œë°± í•¨ìˆ˜ì—ì„œëŠ” ì…ë ¥ëœ ìê²© ì •ë³´ê°€ ì˜¬ë°”ë¥¸ì§€ ê²€ì¦í•˜ê³ , ìœ íš¨í•œ ê²½ìš°ì—ëŠ” ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

ì´ ë°©ì‹ì€ Google, Githubê³¼ ê°™ì€ ì™¸ë¶€ ì œê³µìë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒê³¼ ë‹¬ë¦¬, ì• í”Œë¦¬ì¼€ì´ì…˜ ìì²´ì—ì„œ ì‚¬ìš©ì ìê²© ì •ë³´ë¥¼ ì§ì ‘ ë‹¤ë£¨ê³ ì í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.


> **Note:** ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” Google, Githubë“± ì†Œì…œë¡œê·¸ì¸ì€ ë‹¤ë£¨ì¦ˆ ì•ŠìŠµë‹ˆë‹¤.

## 4. íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ ì²˜ë¦¬

### 4.1 íšŒì›ê°€ì…

Next-AuthëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸(ì¸ì¦) ê¸°ëŠ¥ë§Œ ì œê³µí•˜ê³ , íšŒì›ê°€ì…ì€ ë”°ë¡œ ìì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ íšŒì›ê°€ì… ê°™ì€ ê²½ìš°ëŠ” ë³„ë„ì˜ íšŒì›ê°€ì… API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ë˜ì§€ , `signIn` í•¨ìˆ˜ì˜ ì¸ìê°’ìœ¼ë¡œ ë¡œê·¸ì¸, íšŒì›ê°€ì…ì„ êµ¬ë¶„í•œ í›„ ì²˜ë¦¬í•´ë„ ë©ë‹ˆë‹¤.

ì´ í¬ìŠ¤íŒ…ì—ì„œëŠ” signIn í•¨ìˆ˜ì˜ ì¸ìê°’ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ íšŒì›ê°€ì…ì„ í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```tsx

// config/auth-config.ts

export const authConfig: NextAuthConfig = {
  providers: [
    Credentials({
      async authorize(
        credentials: Partial<Record<string, unknown>>,
      ): Promise<User | null> {
        const creds = credentials as UserCredentials;

        try {
          if (creds?.isSignup && creds.name) {
            const { name, email, password } = creds;

            const { response, data } = await registerUser({
              name,
              email,
              password,
            });

            throw new AuthError(
              response.status,
              "User registered successfully but requires login.",
            );
          }

          const { email, password } = creds;

          const data = await requestSignIn({ email, password });
          return {
            id: data?.user.id,
            email: data?.user.email,
            name: data?.user?.name ?? "user",
            accessToken: data?.tokens.accessToken,
          };
        } catch (err) {
          if (err instanceof AuthError) {
            throw new AuthError(
              err.statusCode || 400,
              err.message || "ìš”ì²­ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤.",
            );
          }
          throw new AuthError(400, "ìš”ì²­ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤.");
        }
      },
    }),
  ],
}
```

```tsx
import NextAuth from "next-auth";

import { authConfig } from "@/config/auth-config";

export const { handlers, auth, signIn, signOut } = NextAuth(authConfig);

```

ì‚¬ìš©ì ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ì„¤ì •í• ë ¤ë©´ **Credentials Provider**ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ì´ í”„ë¡œë°”ì´ë”ëŠ” ë¡œê·¸ì¸ í¼ì— ì…ë ¥ëœ ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ ë“±ì˜ ì¸ì¦ ì •ë³´ë¥¼ `authorize` ì½œë°±ì„ í†µí•´ ì¸ì¦ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.

ë¨¼ì € ì„¤ì • íŒŒì¼ì—ì„œ  **Credentials Provider**ë¥¼ ì´ˆê¸°í™”í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ì‘ì—…ì„ ìœ„í•´ í”„ë¡œë°”ì´ë”ë¥¼ import í•œ í›„ `provider` ë°°ì—´ì— ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.(êµ¬ê¸€,ê¹ƒí—™ë“± ì†Œì…œë¡œê·¸ì¸ì„ ì¶”ê°€í• ë ¤ë©´ ì´ Provider ë°°ì—´ì— ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.)

ì € ê°™ì€ ê²½ìš°ëŠ” íšŒì›ê°€ì…ì´ ì •ìƒì ìœ¼ë¡œ ì„±ê³µ í•˜ì˜€ìœ¼ë©´ `throw new AuthError()` Error ê°ì²´ë¥¼ í™•ì¥í•œ AuthError ê°ì²´ë¥¼ ì‚¬ìš©í•´ì„œ ë©”ì„¸ì§€ë¥¼ í†µí•´ì„œ íšŒì›ê°€ì… ì„±ê³µì—¬ë¶€ë¥¼ ì²´í¬í–ˆìŠµë‹ˆë‹¤. (ê¹”ë”í•œ ë°©ë²•ì€ ì•„ë‹Œê±° ê°™ì€ë° ì–µì§€ë¡œ í•˜ë‹¤ë³´ë‹ˆ ì´ë ‡ê²Œ ì‘ì„±í•˜ì˜€ê³ , ë§Œì•½ íšŒì›ê°€ì… í›„ ë°”ë¡œ ë¡œê·¸ì¸ì„ ì²˜ë¦¬í• ë ¤ë©´ ë°”ë¡œ ë¡œê·¸ì¸ APIë¥¼ í˜¸ì¶œí•´ì„œ ì§„í–‰í•˜ë©´ ë©ë‹ˆë‹¤.)

`authorize`í•¨ìˆ˜ì— ì²«ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ credentialsì— ë“¤ì–´ì˜¤ëŠ” ê°’ì€ ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ë˜ëŠ” signIn í•¨ìˆ˜ì˜ ë‘ë²ˆì§¸ ë§¤ê°œë³€ìˆ˜ì˜ ê°’ì´ ì—¬ê¸°ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.

```tsx

// SignIn Page
"use client";
import { useFormState } from "react-dom";
import { handleSignupAction } from "@/app/actions/signup-action";

interface Props {
  errors: any;
  message: string;
  success?: boolean;
}
const initialState: Props = {
  errors: {},
  message: "",
  success: false,
};

export default function Page() {
  const [state, formAction, isPending] = useFormState(
    handleSignupAction,
    initialState,
  );
  const router = useRouter();

  useEffect(() => {
    if (state && state.success) {
      alert("íšŒì›ê°€ì…ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      router.push("/signin");
    }
  }, [state]);

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-r from-blue-100 to-purple-100">
      <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-800 mb-2">íšŒì›ê°€ì…</h1>
          <p className="text-gray-600">ìƒˆë¡œìš´ ê³„ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</p>
        </div>

        <form action={formAction} className="space-y-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ì´ë¦„
            </label>
            <input
              name="name"
              type="text"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="í™ê¸¸ë™"
              required
            />
            {state.errors?.name && (
              <p className="mt-1 text-sm text-red-500">{state.errors.name}</p>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ì´ë©”ì¼
            </label>
            <input
              name="email"
              type="email"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="example@email.com"
              required
            />
            {state.errors?.email && (
              <p className="mt-1 text-sm text-red-500">{state.errors.email}</p>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ë¹„ë°€ë²ˆí˜¸
            </label>
            <input
              name="password"
              type="password"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              required
            />
            {state.errors?.password && (
              <p className="mt-1 text-sm text-red-500">
                {state.errors.password}
              </p>
            )}
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            </label>
            <input
              name="confirmPassword"
              type="password"
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              required
            />
            {state.errors?.confirmPassword && (
              <p className="mt-1 text-sm text-red-500">
                {state.errors.confirmPassword}
              </p>
            )}
          </div>

          <button
            type="submit"
            disabled={isPending}
            className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-200 transition duration-200 flex items-center justify-center"
          >
            {isPending ? (
              <>
                <svg
                  className="animate-spin -ml-1 mr-3 h-5 w-5 text-white"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                  ></circle>
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  ></path>
                </svg>
                ì²˜ë¦¬ì¤‘...
              </>
            ) : (
              "íšŒì›ê°€ì…"
            )}
          </button>

          {state.message && !state.success && (
            <p className="text-center text-sm text-red-500">{state.message}</p>
          )}

          {state.message && state.success && (
            <p className="text-center text-sm text-green-600">
              {state.message}
            </p>
          )}
        </form>

        <p className="mt-8 text-center text-sm text-gray-600">
          ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?{" "}
          <a
            href="/login"
            className="text-blue-600 hover:text-blue-700 font-medium"
          >
            ë¡œê·¸ì¸í•˜ê¸°
          </a>
        </p>
      </div>
    </div>
  );
}
```
ì„œë²„ì»´í¬ë„ŒíŠ¸ë¡œ ë¡œê·¸ì¸ í¼ì„ ìƒì„± í•œ í›„ ì„œë²„ì•¡ì…˜ìœ¼ë¡œ ë°”ë¡œ ë¡œê·¸ì¸ í•¨ìˆ˜ë¥¼ ìƒì„±í•´ë„ ë˜ì§€ë§Œ useFromState í›…ì„ ì´ìš©í•´ì„œ pending ìƒíƒœë¥¼ ì²˜ë¦¬ ë° ì—ëŸ¬ì²˜ë¦¬ë¥¼ í•˜ì˜€ìŠµë‹ˆë‹¤.

ì´í›„ stateì˜ `success:true`ê°’ì´ë¼ë©´ `signIn`í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
```ts
"use server"
import { signIn } from "@/auth";

export async function registerUser({ name, email, password, }: SignupCredentials) {
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/auth/signup`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password, name }),
    });

    const data = await response.json();
    if (!response.ok) {
      throw new AuthError(response.status, data.message, data);
    }
    return { data, response };
  } catch (err) {
    throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}


export async function handleSignupAction(prevState: any, formData: FormData) {
  try {
    const rowFormData = {
      username: formData.get("name")?.toString(),
      email: formData.get("email")?.toString(),
      password: formData.get("password")?.toString(),
      confirmPassword: formData.get("confirmPassword")?.toString(),
    };

    const validatedFields = signupSchema.safeParse(rowFormData);

    if (!validatedFields.success) {
      return {
        errors: validatedFields.error.flatten().fieldErrors as any,
        message: "ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
      };
    }

    await signIn("credentials", {
      name: rowFormData.username,
      email: rowFormData.email,
      password: rowFormData.password,
      isSignup: true,
      redirect: false,
    });

    return {
      success: true,
      message: "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
    };
  } catch (err: any) {
    if (
      err?.cause?.err?.message ===
      "User registered successfully but requires login." &&
      err?.cause?.err.statusCode === 201
    ) {
      return {
        success: true,
        message: "íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
      };
    }

    return {
      errors: true,
      message: err?.cause?.err?.message || "ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
    };
  }
}
```

`signIn` í•¨ìˆ˜ì— íŠ¹ì • providerë¥¼ ì „ë‹¬í•˜ë©´(ì—¬ê¸°ì„  credentials êµ¬ê¸€ë¡œê·¸ì¸ì´ë©´ google ë“±), í•´ë‹¹ providerë¥¼ í†µí•´ ë°”ë¡œ ë¡œê·¸ì¸ ì‹œë„ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì»¤ìŠ¤í…€ ë¡œê·¸ì¸ í˜ì´ì§€ë¥¼ ì„¤ì •í•˜ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” ê¸°ë³¸ ë¡œê·¸ì¸ í˜ì´ì§€ì¸ `/[basePath]/signin`ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.

ì´í›„ ì„¹ì…˜ì—ì„œ config ê°’ì— ì¶”ê°€í•˜ëŠ” ë°©ë²•ì„ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

ë§Œì•½ ë¡œê·¸ì¸ í›„ `/dashboard`ì™€ ê°™ì€ íŠ¹ì • í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜í•˜ë ¤ë©´, `signIn`ì˜µì…˜ì— `redirectTo`ë¥¼ ì„¤ì •í•˜ì—¬ ì›í•˜ëŠ” URLë¡œ ì‚¬ìš©ìë¥¼ ë³´ë‚´ë©´ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” useFormStateë¥¼ ì´ìš©í•´ì„œ `sccuess: true`ì¸ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì˜€ìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³  ì—¬ê¸°ì„œëŠ” auth-config.ts ì—ì„œ `authorzie` í•¨ìˆ˜ì—ì„œ íšŒì›ê°€ì…ì„ ì„±ê³µí•˜ë©´ Error throw í–ˆê¸° ë•Œë¬¸ì— ìœ„ì²˜ëŸ¼ catchë¬¸ì—ì„œ message, status ê°’ìœ¼ë¡œ í™•ì¸ í›„ ì²˜ë¦¬ë¥¼ í–ˆìŠµë‹ˆë‹¤.


### 4.2 ë¡œê·¸ì¸ í•˜ê¸°

```tsx
import { NextAuthConfig, User } from "next-auth";
import Credentials from "next-auth/providers/credentials";
import {  UserCredentials } from "@/types/auth";
import { registerUser } from "@/app/actions/signup-action";
import { AuthError } from "@/app/lib/auth-error";
import { requestSignIn } from "@/app/actions/signin-action";
import { AUTH_CONSTANTS } from "@/contants/auth";
import { handleTokenRefreshAction } from "@/app/actions/auth-action";

export const authConfig: NextAuthConfig = {
  providers: [
    Credentials({
      async authorize(
        credentials: Partial<Record<string, unknown>>,
      ): Promise<User | null> {
        const creds = credentials as UserCredentials;

        try {
          if (creds?.isSignup && creds.name) {
            const { name, email, password } = creds;

            const { response, data } = await registerUser({
              name,
              email,
              password,
            });

            throw new AuthError(
              response.status,
              "User registered successfully but requires login.",
            );
          }

          const { email, password } = creds;

          const data = await requestSignIn({ email, password });
          return {
            id: data?.user.id,
            email: data?.user.email,
            name: data?.user?.name ?? "user",
            accessToken: data?.tokens.accessToken,
          };
        } catch (err) {
          if (err instanceof AuthError) {
            throw new AuthError(
              err.statusCode || 400,
              err.message || "ìš”ì²­ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤.",
            );
          }
          throw new AuthError(400, "ìš”ì²­ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤.");
        }
      },
    }),
  ],
  pages: { // ë¡œê·¸ì¸ í˜ì´ì§€ ì»¤ìŠ¤í…€ ê²½ë¡œ ì²˜ë¦¬
    signIn: "/signIn",
  },
  session: {
    strategy: 'jwt', 
    maxAge: AUTH_CONSTANTS.NEXT_SERVER_JWT_EXPIRY,
  },
  callbacks: {
    async authorized({ auth }) {
      return !!auth;
    },

    async jwt({ token, user }) {
      if (user) {
        return {
          ...token,
          accessToken: user.accessToken,
          accessTokenExpires:
            Date.now() + AUTH_CONSTANTS.ACCESS_TOKEN_EXPIRE_TIME,
        };
      }

      if (
        token.accessTokenExpires &&
        Date.now() <
          token.accessTokenExpires - AUTH_CONSTANTS.REFRESH_TIME_BEFORE_EXPIRY
      ) {
        return token;
      }

      try {
        const result = await handleTokenRefreshAction();

        return {
          ...token,
          accessToken: result.accessToken,
          accessTokenExpires:
            Date.now() + AUTH_CONSTANTS.ACCESS_TOKEN_EXPIRE_TIME,
        };
      } catch (error) {
        return null;
      }
    },

    async session({ session, token }) {
      if (session.user) {
        session.user.id = token.sub!;
      }
      
      session.accessToken = token.accessToken;
      session.accessTokenExpires = token.accessTokenExpires;
      return session;
    },
  },
};

```
> **Note:** í¬ìŠ¤íŒ…ì— ë‚˜ì˜¤ëŠ” signIn í•¨ìˆ˜ëŠ” auth.ts ì—ì„œ export í•œ signIn í•¨ìˆ˜ì…ë‹ˆë‹¤.(next-auth/react ğŸ™…â€â™€ï¸)



auth-configì˜ ê°’ì„ ìš°ì„  ìœ„ì— ì½”ë“œì²˜ëŸ¼ ì™„ì„±í•˜ì˜€ê³ , í•˜ë‚˜í•˜ë‚˜ì”© ë¶„í•´í•´ì„œ ë³´ê² ìŠµë‹ˆë‹¤. signIn í•¨ìˆ˜ë¥¼ í˜¸ì¶œì„ í•˜ë©´ `authorize` í•¨ìˆ˜ê°€ í˜¸ì¶œì´ ëœ í›„ callbacks ì•ˆì— ìˆëŠ” `jwt` í•¨ìˆ˜ ì‹¤í–‰ => `session` í•¨ìˆ˜ê°€ ì‹¤í–‰ì´ ë©ë‹ˆë‹¤.
`authorize` => `jwt` => `session` ì´ëŸ° ìˆœì„œë¡œ ë™ì‘ì„ í•©ë‹ˆë‹¤.

- callbacks.jwt: í† í°ì˜ ìƒì„±ê³¼ ìˆ˜ì •ì„ ë‹´ë‹¹í•˜ê³  ë°˜í™˜í•œ í† í°ê°’ì„ ê°€ì§€ê³  ì„¸ì…˜ì„ ìƒì„± í›„ ì¿ í‚¤ì— ì €ì¥í•©ë‹ˆë‹¤. jwtí•¨ìˆ˜ì˜ ë§¤ê°œë³€ìˆ˜ userê°ì²´ëŠ” authorize í•¨ìˆ˜(provider)ì—ì„œ ë°˜í™˜í•œ ê°ì²´ê°€ í¬í•¨ì´ ë˜ì–´ ìˆìŠµë‹ˆë‹¤. userê°’ì€ ìµœì´ˆ ë¡œê·¸ì¸ì‹œì—ë§Œ ê°’ì´ ìˆìŠµë‹ˆë‹¤. next-authëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í† í°ì„ ì•”í˜¸í™”í•´ì„œ nextì„œë²„ì˜ í† í°ì„ ì¿ í‚¤ì— ì €ì¥í•©ë‹ˆë‹¤. (jwt ë§Œë£Œê¸°í•œì€ ê¸°ë³¸ê°’ì€ 30ì¼ì…ë‹ˆë‹¤. session ê°ì²´ì˜ maxAgeê°’ìœ¼ë¡œ ë°”ê¿€ìˆ˜ ìˆìŠµë‹ˆë‹¤. ) 
- callbacks.session: ì„¸ì…˜ì„ í™•ì¸í• ë•Œ ë§ˆë‹¤ í˜¸ì¶œë©ë‹ˆë‹¤. `auth`ë¥¼ í˜¸ì¶œí•´ì„œ sessionê°’ì„ í™•ì¸ í•  ìˆ˜ ìˆê³  ì¶”ê°€í•  ê°’ì„ ì¶”ê°€í•˜ë©´ ë‹¤ë¥¸ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- callback.authorized : authorized() í•¨ìˆ˜ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µí•´ ì‚¬ìš©ìê°€ ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš° í˜¸ì¶œë©ë‹ˆë‹¤. authorized í•¨ìˆ˜ëŠ” ì¸ì¦ì´ í•„ìš”í•œ ìš”ì²­ì—ì„œ ì‹¤í–‰ë˜ë©°, íŠ¹ì • ì¡°ê±´ì— ë”°ë¼ NextResponseë¥¼ ë°˜í™˜í•˜ì—¬ ê¸°ë³¸ ë™ì‘ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. params.auth: ì¸ì¦ëœ ì‚¬ìš©ì ë˜ëŠ” í† í° ì •ë³´ (ì—†ì„ ê²½ìš° null). trueë¥¼ ë°˜í™˜ì‹œ ìš”ì²­ì´ ìŠ¹ì¸ì´ë˜ê³  falseë¥¼ ë°˜í™˜í•˜ë©´ ì ‘ê·¼ì´ ì°¨ë‹¨ ë©ë‹ˆë‹¤. ìì„¸í•œë‚´ìš©ì€ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

jwt í•¨ìˆ˜ì—ì„œëŠ” ì™¸ë¶€ ë°±ì—”ë“œ API access_token ë§Œë£Œê¸°í•œì„ ì„¤ì •ì„ í•˜ê³  ë§Œì•½ ë§Œë£Œê¸°í•œì´ 30ì´ˆì´ë‚´ë¡œ ë‚¨ì•„ ìˆë‹¤ë©´ refresh í† í°ìœ¼ë¡œ ë‹¤ì‹œ accessTokenì„ ë°œê¸‰ë°›ëŠ” ë°©ì‹ìœ¼ë¡œ í–ˆìŠµë‹ˆë‹¤. ì´í›„ ë¦¬í”„ë ˆì‰¬ í† í°ë„ ë§Œë£Œê°€ ëœë‹¤ë©´ nullì„ ë¦¬í„´í•´ì„œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ê²Œí–ˆìŠµë‹ˆë‹¤.(ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ì€ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì²˜ë¦¬)


```tsx
//LoginForm
export default function LoginForm() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const [state, formAction, isPending] = useFormState(
    handleSignInAction,
    initialState,
  );

  const [error, setError] = useState("");
  const callbackUrl = useMemo(() => {
    return searchParams.get("callbackUrl") || "/dashboard";
  }, [searchParams]);

  useEffect(() => {
    if (state && state.success) {
      const redirectionUrl = callbackUrl ?? "/dashboard";
      router.replace(redirectionUrl);
    }
  }, [state]);
  return ( 
    <form action={formAction}>...</form>
  )

}
```



-----------------------



```tsx

// /app/actions/sign-in-action.ts
"use server"

export async function requestSignIn({ email, password, }: SignInCredentials): Promise<SignInResponse> {
  try {
    const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });
    if (!response.ok) {
      throw new AuthError(response.status, response.statusText, null);
    }
    const setCookieHeader = response.headers.get("set-cookie");
    if (setCookieHeader) {
      const cookieOptions = parseCookieHeader(setCookieHeader);

      const refreshToken = cookieOptions["refresh_token"];
      if (typeof refreshToken === "string") {
        setRefreshTokenCookie(refreshToken, {
          httpOnly: cookieOptions["httponly"] === true,
          sameSite:
            (cookieOptions["samesite"] as "lax" | "strict" | "none") || "lax",
          path:
            typeof cookieOptions["path"] === "string"
              ? cookieOptions["path"]
              : undefined,
          maxAge:
            typeof cookieOptions["max-age"] === "string"
              ? parseInt(cookieOptions["max-age"])
              : undefined,
        });
      }
    }

    const data = await response.json();

    return data;
  } catch (err) {
    throw new Error("ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}


export async function handleSignInAction(_: any, formData: FormData) {
  try {
    const rowFormData = {
      email: formData.get("email")?.toString(),
      password: formData.get("password")?.toString(),
    };

    const validationFields = signInSchema.safeParse(rowFormData);

    if (!validationFields.success) {
      return {
        errors: validationFields.error.flatten().fieldErrors as any,
        message: "ì…ë ¥ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
      };
    }

    await signIn("credentials", {
      email: rowFormData.email,
      password: rowFormData.password,
      redirect: false,
    });

    return {
      success: true,
      message: "ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
    };
  } catch (err: any) {
    return {
      errors: true,
      message: err?.cause?.err?.message || "ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
    };
  }
}
```
## 5. ë¯¸ë“¤ì›¨ì–´ë¡œ ì¸ì¦ í™•ì¸
ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µí•´ í˜ì´ì§€ ì ‘ê·¼ì„ ì œì–´í•˜ê³  ì¸ì¦ì„ ê´€ë¦¬í•  ìˆ˜ ìˆê³ , ë¯¸ë“¤ì›¨ì–´ëŠ” ìš”ì²­ì´ ì™„ë£Œë˜ê¸° ì „ì— ì‹¤í–‰ë˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤. Next.jsì—ì„œëŠ” í˜ì´ì§€ê°€ ë Œë”ë§ë˜ê¸° ì „ì— ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ë©°, ì´ë¥¼ í†µí•´:

- ì¸ì¦ í™•ì¸
- ë¦¬ë‹¤ì´ë ‰ì…˜
- ìš”ì²­/ì‘ë‹µ í—¤ë” ìˆ˜ì •
- ë¼ìš°íŠ¸ ë³´í˜¸

```ts
import { auth } from "@/auth";
export default auth((req) => {
  if (!req.auth) {
    const newUrl = new URL("/signIn", req.nextUrl.origin);
    return Response.redirect(newUrl);
  }
});

export const config = {
  matcher: [
    "/((?!api|_next/static|_next/image|favicon.ico|signIn|signup|posts).*)",
  ],
};
```

1. `matcher` ì„¤ì •
    - config ê°ì²´ì˜ matcherëŠ” ë¯¸ë“¤ì›¨ì–´ê°€ ì ìš©ë  ê²½ë¡œë¥¼ ì •ì˜í•©ë‹ˆë‹¤. ì´ ì½”ë“œì—ì„œëŠ” api, _next/static, _next/image, favicon.ico, signIn, signup, posts ê²½ë¡œë¥¼ ì œì™¸í•œ ëª¨ë“  ê²½ë¡œì—ì„œ ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
    - signIn, signup, postsì™€ ê°™ì€ í˜ì´ì§€ëŠ” ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥í•˜ë©°, ë‚˜ë¨¸ì§€ ê²½ë¡œëŠ” ì¸ì¦ì´ í•„ìš”í•œ ë³´í˜¸ëœ ê²½ë¡œë¡œ ì„¤ì •ë©ë‹ˆë‹¤.
2. ì‘ë™ë°©ì‹
    - ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ Next AuthëŠ” `authorized` ì½œë°±ì„ ì‹¤í–‰(auth-config.ts > callbacks > authorized)
    - ì½œë°±ì˜ ê²°ê³¼ê°€ `req.auth`ì— ë°˜ì˜
    - `authorized` ì½œë°±ì´ `false`ë¥¼ ë°˜í™˜í•˜ë©´ `req.auth`ëŠ” null
    - `true`ë¥¼ ë°˜í™˜í•˜ë©´ `req.auth`ì— ì„¸ì…˜ì •ë³´ê°€ í¬í•¨ë¨.
    - nullì´ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™

## 6. ì»´í¬ë„ŒíŠ¸ì—ì„œ Session ì‚¬ìš©í•´ë³´ê¸°

### 6.1 ì„œë²„ ì»´í¬ë„ŒíŠ¸

```tsx
import { auth } from "@/auth";

export default async function Page() {
  const data = await auth();
  return <div>Dashboard Page</div>;
}
```

auth.tsì—ì„œ export í•œ authê°’ì„ ë¶ˆëŸ¬ì™€ì„œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

## 6.2 í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸

ê¸°ì¡´ì—ëŠ” next-auth/react ê°’ì„ ì‚¬ìš©í•˜ë©´ ë˜ì§€ë§Œ, ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì»¤ìŠ¤í…€í›…ìœ¼ë¡œ ì‘ì„±í•´ì„œ ì‚¬ìš©í•´ì„œ ê°’ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
// SessionContext.tsx
"use client";

import { useContext, useEffect, useState, createContext } from "react";
import type { Session } from "next-auth";
import { usePathname } from "next/navigation";
import { getSession } from "@/app/actions/signin-action";

const SessionContext = createContext<Session | null>(null);

export const SessionProvider = ({
  children,
}: {
  children: React.ReactNode;
}) => {
  const pathname = usePathname();
  const [session, setSession] = useState<Session | null>(null);

  useEffect(() => {
    getSession().then((res) => {
      setSession(res);
    });
  }, [pathname]);
  return (
    <SessionContext.Provider value={session}>
      {children}
    </SessionContext.Provider>
  );
};

export const useSession = () => {
  return useContext(SessionContext);
};


//layout.tsx
<SessionProvider>
   <Header />
   {children}
</SessionProvider>

```
-------
```tsx
// Profile Page
"use client";
import { useSession } from "@/app/context/SessionContext";

export default function Page() {
  const session = useSession();
  return <div>Profile Page</div>;
}
```



## ì°¸ê³ 

[Auth.js V5 ê³µì‹ë¬¸ì„œ](https://authjs.dev/)

[Auth.js(NextAuth.js) í•µì‹¬ ì •ë¦¬](https://www.heropy.dev/p/MI1Khc)
